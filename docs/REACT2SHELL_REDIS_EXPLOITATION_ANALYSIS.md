# React2Shell + Redis Exploitation Analysis

## ðŸš¨ Attack Chain Analysis

### Attack Flow
```
1. Attacker discovers Next.js 15.4.2 (vulnerable to React2Shell)
   â†“
2. Exploits CVE-2025-55182 (React2Shell) via React Server Components
   â†“
3. Gains Remote Code Execution (RCE) on your server
   â†“
4. Discovers Redis exposed on 0.0.0.0:6379 (accessible from internet)
   â†“
5. Exploits Redis to:
   - Write malicious data
   - Execute commands via Redis modules
   - Use Redis as a backdoor
   - Exfiltrate data
   â†“
6. Downloads and executes cryptominers
   â†“
7. Sets up persistence (cron jobs, systemd services)
```

---

## ðŸ” React2Shell Vulnerability (CVE-2025-55182)

### What It Is
- **CVE**: CVE-2025-55182
- **Name**: React2Shell
- **Severity**: CRITICAL (CVSS 9.8)
- **Type**: Remote Code Execution (RCE)
- **Affected**: React 19.0.0 - 19.2.0, Next.js 15.x, 16.x

### How It Works
1. Exploits unsafe deserialization in React Server Components "Flight" protocol
2. Attacker sends specially crafted HTTP requests
3. Malicious payload is deserialized and executed on the server
4. Allows arbitrary JavaScript code execution

### Your Vulnerable Versions
- **React**: 19.1.0 âŒ (vulnerable)
- **Next.js**: 15.4.2 âŒ (vulnerable)

### Patched Versions
- **React**: 19.2.1+ âœ…
- **Next.js**: 15.0.5, 15.1.9, 15.2.6, 15.3.6, 15.4.8, 15.5.7, 16.0.7+ âœ…

---

## ðŸ” Redis Exposure Vulnerability

### Your Current Configuration (INSECURE)
```yaml
redis:
  ports:
    - "6379:6379"  # Exposes Redis to 0.0.0.0:6379 (ALL INTERFACES)
```

**Problems:**
1. âœ… Redis is accessible from the internet
2. âœ… No authentication required
3. âœ… No firewall protection
4. âœ… Can be used for command execution
5. âœ… Can store malicious payloads
6. âœ… Can be used as a backdoor

### How Attackers Exploit Exposed Redis

1. **Unauthorized Access**
   ```bash
   redis-cli -h YOUR_SERVER_IP -p 6379
   # No password required - full access!
   ```

2. **Command Execution via Redis Modules**
   - Load malicious Redis modules
   - Execute system commands
   - Write to filesystem

3. **Data Exfiltration**
   - Read all keys
   - Extract sensitive data
   - Monitor for credentials

4. **Persistence**
   - Store backdoor commands
   - Set up scheduled tasks
   - Maintain access

5. **Denial of Service**
   - Flood Redis with data
   - Crash the service
   - Exhaust memory

---

## ðŸ›¡ï¸ Security Measures

### 1. IMMEDIATE: Update Next.js and React

```bash
cd apps/web
npm update next@latest react@latest react-dom@latest
npm audit fix --force
```

**Target versions:**
- Next.js: 15.5.7 or 16.0.7+
- React: 19.2.1+
- React-DOM: 19.2.1+

### 2. CRITICAL: Secure Redis Configuration

#### Option A: Bind to Localhost Only (Recommended for Docker)

```yaml
redis:
  image: redis:7-alpine
  container_name: redis
  command: 
    - redis-server
    - --bind
    - 127.0.0.1  # Only localhost
    - --appendonly
    - yes
    - --requirepass
    - ${REDIS_PASSWORD}  # Strong password
  ports:
    # REMOVE THIS - Don't expose to host
    # - "6379:6379"
  networks:
    - internal  # Internal network only
  volumes:
    - redis-data:/data
    - ./redis.conf:/usr/local/etc/redis/redis.conf:ro
```

#### Option B: Use Internal Docker Network (Best Practice)

```yaml
redis:
  image: redis:7-alpine
  container_name: redis
  command: 
    - redis-server
    - --requirepass
    - ${REDIS_PASSWORD}
    - --appendonly
    - yes
    - --protected-mode
    - yes
  # NO PORTS EXPOSED - Only accessible within Docker network
  networks:
    - internal
  volumes:
    - redis-data:/data
```

#### Option C: Use Redis Configuration File

Create `infra/docker/redis.conf`:

```conf
# Bind only to localhost
bind 127.0.0.1

# Require password authentication
requirepass YourStrongPasswordHere

# Enable protected mode
protected-mode yes

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""
rename-command EVAL ""
rename-command DEBUG ""

# Limit memory
maxmemory 256mb
maxmemory-policy allkeys-lru

# Enable AOF persistence
appendonly yes
appendfsync everysec

# Logging
loglevel notice
```

Update docker-compose.yml:

```yaml
redis:
  image: redis:7-alpine
  container_name: redis
  command: redis-server /usr/local/etc/redis/redis.conf
  volumes:
    - redis-data:/data
    - ./redis.conf:/usr/local/etc/redis/redis.conf:ro
  networks:
    - internal
  # NO PORTS - Internal only
```

### 3. Network Segmentation

Create internal Docker network:

```yaml
networks:
  internal:
    driver: bridge
    internal: true  # No external access
```

Update services to use internal network:

```yaml
services:
  redis:
    networks:
      - internal
  
  event-consumer:
    networks:
      - internal
  
  # Only expose web service
  web:
    networks:
      - internal
      - default
    ports:
      - "3000:3000"  # Only web is exposed
```

### 4. Firewall Rules

```bash
# Block Redis port from external access
sudo ufw deny 6379
sudo iptables -A INPUT -p tcp --dport 6379 -s 127.0.0.1 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 6379 -j DROP

# Save rules
sudo iptables-save > /etc/iptables/rules.v4
```

### 5. Redis Authentication

#### Set Strong Password

```bash
# Generate strong password
openssl rand -base64 32

# Add to .env file
REDIS_PASSWORD=your_strong_password_here
```

#### Update Application Code

```typescript
// Use password in Redis connection
const redis = new Redis({
  host: process.env.REDIS_HOST || 'redis',
  port: 6379,
  password: process.env.REDIS_PASSWORD, // REQUIRED
  db: 0
});
```

### 6. Environment Variables Security

Create `.env.example`:

```env
# Redis Configuration
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=CHANGE_THIS_STRONG_PASSWORD
REDIS_DB=0

# Never commit .env files!
```

Add to `.gitignore`:
```
.env
.env.local
.env.production
```

### 7. Monitoring Redis Access

```bash
# Monitor Redis connections
redis-cli --latency-history

# Check for unauthorized access
redis-cli CLIENT LIST

# Monitor commands
redis-cli MONITOR
```

### 8. Regular Security Audits

```bash
# Check Redis configuration
redis-cli CONFIG GET "*"

# Verify authentication is required
redis-cli -h YOUR_IP -p 6379 PING
# Should return: (error) NOAUTH Authentication required

# Check for exposed Redis instances
nmap -p 6379 YOUR_SERVER_IP
```

---

## ðŸ“‹ Complete Secure Docker Compose Configuration

```yaml
version: '3.8'

networks:
  internal:
    driver: bridge
    # internal: true  # Uncomment to make network completely internal

services:
  kafka:
    image: bitnamilegacy/kafka:3.7.0-debian-12-r5
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://62.72.29.150:9092
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=false
      - ALLOW_PLAINTEXT_LISTENER=yes
    volumes:
      - kafka-data:/bitnami/kafka
    networks:
      - internal
    healthcheck:
      test: ["CMD", "kafka-topics.sh", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7-alpine
    container_name: redis
    command: 
      - redis-server
      - --requirepass
      - ${REDIS_PASSWORD}
      - --appendonly
      - yes
      - --protected-mode
      - yes
      - --bind
      - 127.0.0.1
      - --port
      - "6379"
    # NO PORTS EXPOSED - Only accessible within Docker network
    volumes:
      - redis-data:/data
    networks:
      - internal
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  event-consumer:
    build:
      context: ../../
      dockerfile: services/event-consumer/Dockerfile
    container_name: event-consumer
    environment:
      - NODE_ENV=development
      - KAFKA_BROKERS=62.72.29.150:9092
      - KAFKA_CLIENT_ID=event-consumer
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    depends_on:
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  kafka-data:
  redis-data:
```

---

## ðŸ”’ Additional Security Measures

### 1. Use Redis Sentinel (High Availability + Security)

For production, consider Redis Sentinel for:
- High availability
- Automatic failover
- Enhanced security

### 2. Use Redis ACLs (Access Control Lists)

```conf
# In redis.conf
user default on >strongpassword ~* &* +@all
user appuser on >apppassword ~app:* +@read +@write -@dangerous
```

### 3. Enable TLS/SSL

```yaml
redis:
  command:
    - redis-server
    - --tls-port
    - "6380"
    - --tls-cert-file
    - /tls/redis.crt
    - --tls-key-file
    - /tls/redis.key
```

### 4. Regular Backups

```bash
# Backup Redis data
docker exec redis redis-cli --no-auth-warning -a ${REDIS_PASSWORD} BGSAVE
docker cp redis:/data/dump.rdb ./backups/redis-$(date +%Y%m%d).rdb
```

### 5. Monitor Redis Metrics

- Connection count
- Memory usage
- Command execution rate
- Failed authentication attempts

---

## âœ… Security Checklist

### Immediate (Do Now)
- [ ] Update Next.js to 15.5.7+ or 16.0.7+
- [ ] Update React to 19.2.1+
- [ ] Remove Redis port exposure from docker-compose.yml
- [ ] Add Redis password authentication
- [ ] Create internal Docker network
- [ ] Set up firewall rules to block Redis port
- [ ] Update application code to use Redis password

### This Week
- [ ] Implement Redis configuration file
- [ ] Set up Redis monitoring
- [ ] Review all Docker port exposures
- [ ] Audit network security
- [ ] Set up automated backups

### This Month
- [ ] Consider Redis Sentinel for production
- [ ] Implement TLS for Redis
- [ ] Set up Redis ACLs
- [ ] Conduct security audit
- [ ] Penetration testing

---

## ðŸš¨ Current Risk Level

**BEFORE fixes:**
- ðŸ”´ CRITICAL: Redis exposed to internet
- ðŸ”´ CRITICAL: No authentication
- ðŸ”´ CRITICAL: Vulnerable Next.js version

**AFTER fixes:**
- ðŸŸ¢ LOW: Redis only accessible internally
- ðŸŸ¢ LOW: Strong authentication required
- ðŸŸ¢ LOW: Patched Next.js version

---

## ðŸ“š References

- [CVE-2025-55182 Details](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2025-55182)
- [React2Shell Security Advisory](https://react.dev/blog/2025/01/09/security-advisory-react-server-components)
- [Redis Security Guide](https://redis.io/docs/management/security/)
- [Docker Network Security](https://docs.docker.com/network/network-tutorial-standalone/)

---

**Remember**: The attack chain was React2Shell â†’ RCE â†’ Redis exploitation. Fixing both vulnerabilities is critical to prevent future attacks.

